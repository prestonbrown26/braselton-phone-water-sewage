{% extends "admin_base.html" %}
{% block title %}Call {{ log.call_id }} - Braselton Utilities{% endblock %}
{% block extra_css %}
<style>
  .detail-page h1 {
    margin-bottom: 6px;
  }
  .detail-layout {
    display: flex;
    flex-wrap: wrap;
    gap: 24px;
  }
  .detail-main {
    flex: 2 1 60%;
    min-width: 300px;
    background: #f8f9fc;
    border-radius: 12px;
    border: 1px solid var(--border);
    padding: 20px;
    white-space: pre-line;
    line-height: 1.7;
  }
  .detail-sidebar {
    flex: 1 1 240px;
    min-width: 260px;
    max-width: 360px;
    background: #fff;
    border-radius: 12px;
    border: 1px solid var(--border);
    padding: 20px;
  }
  .sidebar-section + .sidebar-section {
    margin-top: 18px;
    padding-top: 18px;
    border-top: 1px solid #e5e7f3;
  }
  dt {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
    color: #6b7280;
  }
  dd {
    margin: 0 0 12px 0;
    font-weight: 600;
    color: #1f2937;
    word-break: break-word;
  }
  .event-item {
    border: 1px solid #e4e8fb;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 12px;
    background: #f7f8ff;
  }
  .event-time {
    font-size: 12px;
    color: #6b7496;
    margin-bottom: 4px;
  }
  .event-title {
    font-weight: 600;
    color: #1e2460;
  }
  details summary {
    cursor: pointer;
    color: #3f51c0;
    font-size: 13px;
  }
  details pre {
    margin-top: 6px;
    background: #eef2ff;
    padding: 8px;
    border-radius: 6px;
    white-space: pre-wrap;
  }
  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 16px;
    text-decoration: none;
    color: var(--brand);
    font-weight: 600;
  }
</style>
{% endblock %}
{% block content %}
<div class="card detail-page">
  <a class="back-link" href="{{ url_for('admin.search_transcripts') }}">← Back to transcripts</a>
  <h1>Call {{ log.call_id }}</h1>
  <p class="subtitle">Recorded at {{ log.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>

  <div class="detail-layout">
    <section class="detail-main">
      {{ log.transcript }}
    </section>
    <aside class="detail-sidebar">
      <div class="sidebar-section">
        <h3>Call Metadata</h3>
        <dl>
          <div>
            <dt>Caller</dt>
            <dd>{{ log.caller_number or 'Unknown' }}</dd>
          </div>
          <div>
            <dt>Duration</dt>
            <dd>{{ log.duration_seconds or 'n/a' }} seconds</dd>
          </div>
          <div>
            <dt>Sentiment</dt>
            <dd>{{ log.sentiment or 'neutral' }}</dd>
          </div>
          <div>
            <dt>Transferred</dt>
            <dd>{{ 'Yes' if log.transferred else 'No' }}</dd>
          </div>
          <div>
            <dt>Email Sent</dt>
            <dd>{{ 'Yes' if log.email_sent else 'No' }}</dd>
          </div>
        </dl>
      </div>

      {% if log.email_events %}
      <div class="sidebar-section">
        <h3>Email Activity</h3>
        {% for event in log.email_events %}
        <div class="event-item">
          <div class="event-time">{{ event.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</div>
          <div class="event-title">{{ event.template_type.replace('_',' ')|title }} → {{ event.recipient }}</div>
          <div>Subject: {{ event.subject }}</div>
          <details>
            <summary>View body</summary>
            <pre>{{ event.body }}</pre>
          </details>
        </div>
        {% endfor %}
      </div>
      {% endif %}

      {% if log.transfer_events %}
      <div class="sidebar-section">
        <h3>Transfers</h3>
        {% for event in log.transfer_events %}
        <div class="event-item">
          <div class="event-time">{{ event.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</div>
          <div class="event-title">{{ event.target_number or 'Unknown target' }}</div>
          {% if event.reason %}
          <div>Reason: {{ event.reason }}</div>
          {% endif %}
          {% if event.notes %}
          <div>Notes: {{ event.notes }}</div>
          {% endif %}
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </aside>
  </div>
</div>
{% endblock %}

